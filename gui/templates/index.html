<!DOCTYPE html>
<html>

<head>
  <title>Google Play Application Review Classification</title>
  {% include 'includes.html' %}
</head>

<body>
  <h1 class="titleText">Google Play Application Review Classification </h1>
  <div class="container">
    <div class="tabs">
      <button class="tab active" id="btnTab1" onclick="openTab(event, 'tab1', 'btnTab1')" disabled>Single Review Classification</button>
      <button class="tab active" id="btnTab2" onclick="openTab(event, 'tab2', 'btnTab2')" disabled>Application Reviews Classification</button>
    </div>
    <div id="tab1" class="tab-content">
      <h2>Single Review Classification </h2>
      <p>Enter review text below to be classified.</p>
      <form id="single-text-form" action="/single_text" method="POST">
        <textarea name="review_text" style="height: 150px;" placeholder="Enter your review..." required></textarea>
        <button class="btnSubmit" id="buttonSubmit" type="submit">
            Predict
        </button>
      </form>
    </div>
    <div id="tab2" class="tab-content">
      <div id="inputDiv">
        <h2>Google Play Application Classification</h2>
        <p>Enter google play URL:<br><span style="font-size: 10px; color: gray;"><i>eg: https://play.google.com/store/apps/details?id=co.imba.he</i></span></p>
        <form id="url-form" action="/review" method="POST">
          <textarea name="url" placeholder="Enter url..." required></textarea>
          <button class="btnSubmit" id="buttonSubmit" type="submit" onclick="">
            Predict
          </button>
        </form>
      </div>
      <div id="resultDiv">
        <button class="btnBack" id="btnBack" onclick="$('#resultDiv').hide();$('#inputDiv').show();"><i class="fa-solid fa-angle-left"></i>&nbsp;Back</button>
        <div class="sideBySide">
          <h2>Scraped Reviews:</h2>
          <button class="btnBack" style="float: right;" onclick="showGraph()"><i class="fa-solid fa-chart-pie"></i>&nbsp;Graph View</button>
        </div>
        <table id="dataTable" style="width:100%;"></table>
      </div>
    </div>
  </div>
  <script>
    var label = [];
    var sentimentCount = [];
    const Toast = Swal.mixin({
      toast: true,
      position: 'top-end',
      showConfirmButton: false,
    })
    var currentGraph = "bar"
    function showGraph() {
      var graphData = {
        labels: label,
        datasets: [{
          label: 'Sentiments Count',
          data: sentimentCount,
          backgroundColor: [
            'rgb(255, 99, 132)',
            'rgb(54, 162, 235)',
            'rgb(255, 205, 86)'
          ],
          hoverOffset: 4
        }]
      };
      const graphPopup = Swal.mixin({
        showCloseButton: true,
        showCancelButton: false,
        showConfirmButton: false
      });
      graphPopup.fire({
        html:
          '<button id="toggleGraph" onclick="toggleGraph()">Toggle</button><div class="sideBySide"><canvas id="graph"></canvas></div>',
      });
      toggleGraph(graphData);
    }
    function toggleGraph(graphData) {
      currentGraph = (currentGraph == "bar") ? "pie" : "bar";
      var chart = Chart.getChart("graph");
        if (chart != undefined) {
          chart.destroy();
        }
        chart = new Chart(document.getElementById("graph"),{ 
        type: currentGraph,  
        data: graphData,
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Graph View'
            }
          }
        },
      });
      chart.update();
      // STOP AT FIXING TOGGLE CHART HERE
    }
    $(document).ready(function () {
      var btnTab1 = document.getElementById('btnTab1');
      var btnTab2 = document.getElementById('btnTab2');
      
      $("#resultDiv").hide();
      $("#single-text-form").submit(function (event) {
        event.preventDefault();
        var button = $(this).find('#buttonSubmit');
        var buttonText = $(this).find('#buttonSubmitText');
        button.prop('disabled', true);
        buttonText.html('Processing...');
        var formData = $(this).serialize();
        $.ajax({
          url: '/single_text',
          type: 'POST',
          data: formData,
          success: function (response) {
            var prediction = response.prediction;
            var reviewText = response.review_text;
            prediction = prediction.charAt(0).toUpperCase() + prediction.slice(1);
            if(prediction == "Positive") {
              prediction =  '<span style="color: green; opacity: 0.7;"><b>' + prediction + '</b></span>';
            } else if(prediction == "Negative") {
              prediction =  '<span style="color: red; opacity: 0.7;"><b>' + prediction + '</b></span>';
            } else {
              prediction =  '<span style="opacity: 0.7;"><b>' + prediction + '</b></span>';
            }
            Swal.fire({
              title: 'Classification Result', 
              html: 'Prediction: '+ prediction
              + '<br>Review Text: "' + reviewText + '"',
              icon: 'success',
            })
            button.prop('disabled', false);
            buttonText.html('Predict');
          },
          error: function (error) {
            console.log(error);
            button.prop('disabled', false);
            buttonText.html('Predict');
          }
        });
      });
      $("#url-form").submit(function (event) {
        event.preventDefault();
        $("#resultDiv").hide();
        var button = $(this).find('#buttonSubmit');
        var buttonText = $(this).find('#buttonSubmitText');
        button.prop('disabled', true);
        buttonText.html('Processing...');
        var formData = $(this).serialize();
        Toast.fire({
          icon: 'info',
          title: 'Processing reviews...',
        });
        $.ajax({
          url: '/review',
          type: 'POST',
          data: formData,
          success: function (response) {
              var url = response.url;
              var reviews = response.reviews;
              var sentiments = response.sentiments;
              var appDetails = response.app_details;
              var totalReviews = response.total_scraped_reviews;
              label = response.label;
              sentimentCount = response.sentimentCount;

              var data = [];
              for(var i = 0; i < reviews.length; i++) {
                var array = [];
                array.push((i+1));
                array.push(reviews[i]);
                array.push(sentiments[i]);
                data.push(array);
              }
              if ( $.fn.dataTable.isDataTable( '#dataTable' ) ) {
                  $('#dataTable').DataTable().destroy();
              } 
              button.prop('disabled', false);
              buttonText.html('Predict');
              $("#resultDiv").show();
              $("#inputDiv").hide();
              $('#dataTable').DataTable({
                data: data,
                columns: [
                    { title: '#', width: '10%' },
                    { title: 'Review', width: 'auto' },
                    { title: 'Prediction', width: '12%' }
                ],
                scrollY: '200px',
                paging: true
              });
              Toast.close();
          },
          error: function (error) {
              console.log(error);
              button.prop('disabled', false);
              buttonText.html('Predict');
              $("#resultDiv").hide();
              Toast.close();
              Swal.fire({
                icon: 'error',
                title: 'Oops...',
                html: '<b>Invalid Application ID!</b><p>Check your URL input, make sure you enter a proper application url as shown in the example below<br>(eg: https://play.google.com/store/apps/details?id=co.imba.he)</p>',
              })
          }
        });
      });
     openTab(event, 'tab1', 'btnTab1');
     btnTab1.classList.toggle("active");
     btnTab1.disabled = !btnTab1.disabled;
    });
    function openTab(event, tabName, btnName) {
      var tabContents = document.getElementsByClassName('tab-content');
      for (var i = 0; i < tabContents.length; i++) {
        tabContents[i].style.display = 'none';
      }
    
      var selectedTabContent = document.getElementById(tabName);
      selectedTabContent.style.display = 'block';
    
      btnTab1.classList.toggle("active");
      btnTab2.classList.toggle("active");
      btnTab1.disabled = !btnTab1.disabled;
      btnTab2.disabled = !btnTab2.disabled;
    }
  </script>
</body>

</html>